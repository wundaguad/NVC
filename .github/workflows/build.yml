name: Build Multi-Platform Releases

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pillow customtkinter pyinstaller
    
    - name: Build Windows executable
      run: |
        pyinstaller --onefile --windowed --name "NominalwertRechner" --icon="logo.png" --add-data "logo.png;." nominalwert_rechner.py
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: dist/NominalwertRechner.exe

  # Mac build temporarily disabled due to Gatekeeper compatibility issues
  # build-macos:
  #   runs-on: macos-latest
  #   if: github.event_name == 'push' && (contains(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
  #   
  #   steps:
  #   - uses: actions/checkout@v4
  #   
  #   - name: Set up Python
  #     uses: actions/setup-python@v4
  #     with:
  #       python-version: '3.11'
  #   
  #   - name: Install dependencies
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install pillow customtkinter pyinstaller
  #   
  #   - name: Build Mac app
  #     run: |
  #       pyinstaller --onefile --windowed --name=NominalwertRechner nominalwert_rechner.py
  #       
  #       # Create .app bundle
  #       pyinstaller --windowed --name=NominalwertRechner nominalwert_rechner.py
  #       
  #       # Create DMG (simplified version)
  #       mkdir -p dist/dmg
  #       cp -r dist/NominalwertRechner.app dist/dmg/
  #       hdiutil create -volname "NominalwertRechner" -srcfolder dist/dmg -ov -format UDZO dist/NominalwertRechner-Mac.dmg
  #   
  #   - name: Upload Mac artifacts
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: mac-build
  #       path: |
  #         dist/NominalwertRechner-Mac.dmg
  #         dist/NominalwertRechner.app

  create-release:
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download Windows build
      uses: actions/download-artifact@v4
      with:
        name: windows-build
        path: ./builds/windows/
    
    
    - name: Prepare web version
      run: |
        mkdir -p ./builds/web/
        cp NominalwertRechner_Exact.html ./builds/web/
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./builds/windows/NominalwertRechner.exe
          ./builds/web/NominalwertRechner_Exact.html
          README_GitHub.md
        body: |
          ## üßÆ Nominalwert-Rechner Release
          
          **Multi-platform trading position calculator with leverage support**
          
          ### üì• Downloads:
          - **Windows**: `NominalwertRechner.exe` - Ready to run executable
          - **Web**: `NominalwertRechner_Exact.html` - Works in any browser
          - **Mac/Linux**: Use Python version (see README for instructions)
          
          ### üöÄ Features:
          - Professional leverage trading calculator (1x-125x)
          - Multi-language support (German/English)
          - Dark theme trading interface
          - Risk management with stop-loss/take-profit
          - Fee calculation (maker/taker)
          - Copy-to-clipboard functionality
          - Offline operation
          
          ### üìã Installation:
          - **Windows**: Download .exe and run (may show security warning - click "Run anyway")
          - **Web**: Download .html file and open in browser
          - **Mac/Linux**: Clone repository and run with Python 3
          
          Created with ‚ù§Ô∏è by **WUNDAGUAD** for our trading community
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
