<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💹 Nominalwert-Rechner</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #121212;
            color: #EAEAEA;
            padding: 6px;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .main-container {
            max-width: 400px;
            margin: 0 auto;
            background: #121212;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
            display: flex;
            flex-direction: column;
        }
        
        .card {
            background: #1E1E1E;
            border: 1px solid #333333;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 4px;
            flex-shrink: 0;
        }
        
        /* Title Section */
        .title-section {
            text-align: center;
            margin-bottom: 4px;
            flex-shrink: 0;
        }
        
        .main-title {
            font-size: 12px;
            font-weight: bold;
            color: #e2ff00;
            margin-bottom: 2px;
        }
        
        .credit-line {
            font-size: 7px;
            color: #9598a1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1px;
        }
        
        .heart { color: #FF0000; font-size: 12px; }
        .wundaguad { display: inline-flex; }
        .wundaguad .w1 { color: #FF0000; }
        .wundaguad .w2 { color: #FF6600; }
        .wundaguad .w3 { color: #e2ff00; }
        .wundaguad .w4 { color: #66FF00; }
        .wundaguad .w5 { color: #00FFCC; }
        .wundaguad .w6 { color: #0099FF; }
        .wundaguad .w7 { color: #6666FF; }
        .wundaguad .w8 { color: #CC66FF; }
        .wundaguad .w9 { color: #FF99CC; }
        
        /* Input Section */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .section-title {
            font-size: 12px;
            font-weight: bold;
            color: #e2ff00;
        }
        
        .reset-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 4px 8px;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .reset-btn:hover { background: #ff5252; }
        
        .input-grid {
            display: grid;
            gap: 6px;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            align-items: center;
        }
        
        .input-label {
            font-size: 11px;
            font-weight: bold;
            color: #EAEAEA;
        }
        
        .direction-buttons {
            display: flex;
            gap: 25px;
        }
        
        .radio-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .radio-btn input[type="radio"] {
            accent-color: #e2ff00;
        }
        
        .radio-btn.long { color: #4CAF50; }
        .radio-btn.short { color: #9598a1; }
        .radio-btn.short.selected { color: #F44336; }
        .radio-btn.long.selected { color: #4CAF50; }
        
        input[type="number"], input[type="text"] {
            background: #2A2A2A;
            border: 2px solid #333333;
            border-radius: 4px;
            color: #EAEAEA;
            padding: 6px;
            font-size: 11px;
            width: 100%;
        }
        
        input:focus {
            outline: none;
            border-color: #e2ff00;
            box-shadow: 0 0 5px rgba(226, 255, 0, 0.3);
        }
        
        /* Leverage Section */
        .leverage-title {
            font-size: 12px;
            font-weight: bold;
            color: #C9F24A;
            margin-bottom: 8px;
        }
        
        .leverage-display {
            text-align: center;
            margin-bottom: 6px;
        }
        
        .leverage-value {
            font-size: 16px;
            font-weight: bold;
            color: #EAEAEA;
        }
        
        .leverage-slider {
            width: 100%;
            margin: 8px 0;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #2A2A2A;
            border-radius: 3px;
        }
        
        .leverage-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #e2ff00;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .leverage-markers {
            display: flex;
            justify-content: space-between;
            font-size: 8px;
            color: #A0A0A0;
            font-weight: bold;
            margin: 2px 0 8px 0;
        }
        
        .leverage-buttons {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
        }
        
        .leverage-btn {
            background: #2A2A2A;
            color: #EAEAEA;
            border: 1px solid #333333;
            border-radius: 4px;
            padding: 2px;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .leverage-btn:hover {
            background: #e2ff00;
            color: black;
        }
        
        /* Collapsible Sections */
        .collapsible {
            margin-bottom: 12px;
        }
        
        .collapsible-header {
            background: #2A2A2A;
            color: #EAEAEA;
            border: none;
            padding: 8px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 10px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .collapsible-header:hover {
            background: #333333;
        }
        
        .collapsible-content {
            display: none;
            background: #1E1E1E;
            padding: 10px;
            border: 1px solid #333333;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        
        .collapsible-content.active {
            display: block;
        }
        
        /* Calculate Button */
        .calculate-btn {
            background: linear-gradient(135deg, #C9F24A 0%, #e2ff00 100%);
            color: black;
            border: none;
            border-radius: 25px;
            padding: 8px;
            font-size: 10px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            margin: 6px 0 8px 0;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .calculate-btn:hover {
            background: linear-gradient(135deg, #00E676 0%, #00C853 100%);
            transform: translateY(-1px);
        }
        
        /* Results Section */
        .results-grid {
            display: grid;
            gap: 5px;
        }
        
        .result-row {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            align-items: center;
            padding: 5px 0;
        }
        
        .result-label {
            font-size: 9px;
            font-weight: bold;
            color: #EAEAEA;
        }
        
        .result-value {
            font-size: 11px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 3px;
            min-width: 80px;
            text-align: right;
        }
        
        .result-value.success { color: #4ECDC4; }
        .result-value.warning { color: #FFE66D; }
        .result-value.danger { color: #FF4757; }
        .result-value.profit { color: #2ED573; }
        
        .copy-btn {
            background: #4ECDC4;
            color: black;
            border: none;
            border-radius: 3px;
            padding: 4px 6px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .copy-btn:hover { background: #26D0CE; }
        .copy-btn.success { background: #4ECDC4; }
        .copy-btn.warning { background: #FFE66D; }
        .copy-btn.danger { background: #FF4757; color: white; }
        .copy-btn.profit { background: #2ED573; }
        
        /* PnL Analysis */
        .pnl-info {
            font-size: 9px;
            color: #9598a1;
            line-height: 1.4;
            margin-top: 12px;
        }
        
        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 8px;
        }
        
        .settings-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            align-items: center;
        }
        
        .settings-label {
            font-size: 8px;
            font-weight: bold;
            color: #EAEAEA;
        }
        
        select, .combobox {
            background: #2A2A2A;
            border: 2px solid #333333;
            border-radius: 4px;
            color: #EAEAEA;
            padding: 4px;
            font-size: 7px;
        }
        
        .save-btn {
            background: #2A2A2A;
            color: #EAEAEA;
            border: 2px solid #333333;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 9px;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .save-btn:hover {
            border-color: #e2ff00;
            background: #333333;
        }
        
        /* TP Configuration */
        .tp-mode {
            margin-bottom: 8px;
        }
        
        .tp-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        
        .tp-input-group {
            display: grid;
            gap: 3px;
        }
        
        .tp-label {
            font-size: 7px;
            font-weight: bold;
            color: #EAEAEA;
        }
        
        .tp-input {
            background: #2A2A2A;
            border: 2px solid #333333;
            border-radius: 4px;
            color: #EAEAEA;
            padding: 3px;
            font-size: 7px;
        }
        
        /* Language Support */
        .lang-de .english-only { display: none; }
        .lang-en .german-only { display: none; }
        
        /* Responsive */
        @media (max-width: 400px) {
            .main-container { max-width: 100%; }
            .input-row { grid-template-columns: 1fr; gap: 4px; }
            .leverage-buttons { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body class="lang-de" id="app">
    <div class="main-container">
        <div class="scrollable-content">
            <!-- Title Section -->
            <div class="title-section">
                <div class="main-title" data-text="title">💹 Nominalwert-Rechner</div>
                <div class="credit-line">
                    <span>Created with </span>
                    <span class="heart">♥</span>
                    <span> by </span>
                    <span class="wundaguad">
                        <span class="w1">W</span><span class="w2">U</span><span class="w3">N</span><span class="w4">D</span><span class="w5">A</span><span class="w6">G</span><span class="w7">U</span><span class="w8">A</span><span class="w9">D</span>
                    </span>
                    <span> for our community</span>
                </div>
            </div>

            <!-- Basic Settings Card -->
            <div class="card">
                <div class="section-header">
                    <div class="section-title" data-text="basic_settings">📊 Basis-Einstellungen</div>
                    <button class="reset-btn" onclick="resetInputs()">🔄 Reset</button>
                </div>
                
                <div class="input-grid">
                    <div class="input-row">
                        <div class="input-label" data-text="direction">Richtung:</div>
                        <div class="direction-buttons">
                            <label class="radio-btn long selected">
                                <input type="radio" name="direction" value="long" checked onchange="updateDirection()">
                                <span data-text="long">📈 Long</span>
                            </label>
                            <label class="radio-btn short">
                                <input type="radio" name="direction" value="short" onchange="updateDirection()">
                                <span data-text="short">📉 Short</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-label" data-text="entry_price">Einstiegskurs:</div>
                        <input type="number" id="entryPrice" step="0.01" placeholder="z.B. 50000" onkeypress="handleEnter(event)">
                    </div>
                    
                    <div class="input-row">
                        <div class="input-label" data-text="max_loss">Max. Verlust (€):</div>
                        <input type="number" id="maxLoss" step="0.01" value="10.00" onkeypress="handleEnter(event)">
                    </div>
                    
                    <div class="input-row">
                        <div class="input-label" data-text="stop_loss">Stop-Loss (%):</div>
                        <input type="number" id="stopLoss" step="0.01" value="0.51" onkeypress="handleEnter(event)">
                    </div>
                </div>
            </div>

            <!-- Leverage Card -->
            <div class="card">
                <div class="leverage-title">⚡ Hebelwirkung anpassen</div>
                
                <div class="leverage-display">
                    <div class="leverage-value" id="leverageDisplay">1X</div>
                </div>
                
                <input type="range" class="leverage-slider" id="leverageSlider" 
                       min="1" max="125" value="1" oninput="updateLeverage()">
                
                <div class="leverage-markers">
                    <span>1X</span><span>25X</span><span>50X</span><span>75X</span><span>100X</span><span>125X</span>
                </div>
                
                <div class="leverage-buttons">
                    <button class="leverage-btn" onclick="setLeverage(1)">1×</button>
                    <button class="leverage-btn" onclick="setLeverage(25)">25×</button>
                    <button class="leverage-btn" onclick="setLeverage(50)">50×</button>
                    <button class="leverage-btn" onclick="setLeverage(75)">75×</button>
                    <button class="leverage-btn" onclick="setLeverage(100)">100×</button>
                    <button class="leverage-btn" onclick="setLeverage(125)">125×</button>
                </div>
            </div>

            <!-- Collapsible Sections -->
            
            <!-- Trading Fees Section -->
            <div class="collapsible">
                <button class="collapsible-header" onclick="toggleCollapsible(this)">
                    ▶ 💸 Handelsgebühren
                </button>
                <div class="collapsible-content">
                    <div class="settings-grid">
                        <div class="settings-row">
                            <div class="settings-label">Entry:</div>
                            <select id="entrySide">
                                <option value="Taker">Taker</option>
                                <option value="Maker">Maker</option>
                            </select>
                        </div>
                        <div class="settings-row">
                            <div class="settings-label">Exit:</div>
                            <select id="exitSide">
                                <option value="Taker">Taker</option>
                                <option value="Maker">Maker</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fee Settings Section -->
            <div class="collapsible">
                <button class="collapsible-header" onclick="toggleCollapsible(this)">
                    ▶ ⚙️ Gebühren-Einstellungen
                </button>
                <div class="collapsible-content">
                    <div class="settings-grid">
                        <div class="settings-row">
                            <div class="settings-label">Maker (%):</div>
                            <input type="number" id="makerFee" step="0.001" value="0.014" class="tp-input">
                        </div>
                        <div class="settings-row">
                            <div class="settings-label">Taker (%):</div>
                            <input type="number" id="takerFee" step="0.001" value="0.042" class="tp-input">
                        </div>
                        <div class="settings-row">
                            <div class="settings-label" data-text="number_format">Zahlenformat:</div>
                            <select id="numberFormat" onchange="updateNumberFormat()">
                                <option value="german">Deutsch (115.327,2)</option>
                                <option value="us">US (115,327.2)</option>
                            </select>
                        </div>
                        <div class="settings-row">
                            <div class="settings-label" data-text="language">Sprache:</div>
                            <select id="language" onchange="updateLanguage()">
                                <option value="german">Deutsch</option>
                                <option value="english">English</option>
                            </select>
                        </div>
                    </div>
                    <button class="save-btn" onclick="saveSettings()">💾 Speichern</button>
                </div>
            </div>

            <!-- Take-Profit Configuration -->
            <div class="collapsible">
                <button class="collapsible-header" onclick="toggleCollapsible(this)">
                    ▶ 🎯 Take-Profit Konfiguration
                </button>
                <div class="collapsible-content">
                    <div class="tp-mode">
                        <div class="settings-row">
                            <div class="settings-label">Modus:</div>
                            <select id="tpMode" onchange="updateTPMode()">
                                <option value="r-multiple">R-Multiple</option>
                                <option value="percent">Prozent</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="tp-grid" id="tpRMultiple">
                        <div class="tp-input-group">
                            <div class="tp-label">TP1 (R):</div>
                            <input type="number" id="tp1r" step="0.1" value="1" class="tp-input">
                        </div>
                        <div class="tp-input-group">
                            <div class="tp-label">TP2 (R):</div>
                            <input type="number" id="tp2r" step="0.1" value="2" class="tp-input">
                        </div>
                        <div class="tp-input-group">
                            <div class="tp-label">TP3 (R):</div>
                            <input type="number" id="tp3r" step="0.1" value="3" class="tp-input">
                        </div>
                    </div>
                    
                    <div class="tp-grid" id="tpPercent" style="display: none;">
                        <div class="tp-input-group">
                            <div class="tp-label">TP1 (%):</div>
                            <input type="number" id="tp1p" step="0.01" value="1.00" class="tp-input">
                        </div>
                        <div class="tp-input-group">
                            <div class="tp-label">TP2 (%):</div>
                            <input type="number" id="tp2p" step="0.01" value="2.00" class="tp-input">
                        </div>
                        <div class="tp-input-group">
                            <div class="tp-label">TP3 (%):</div>
                            <input type="number" id="tp3p" step="0.01" value="3.00" class="tp-input">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calculate Button -->
            <button class="calculate-btn" onclick="calculate()">
                <span data-text="calculate">🚀 Berechnen</span>
            </button>

            <!-- Results Card -->
            <div class="card">
                <div class="section-title" data-text="results">📈 Berechnungsergebnisse</div>
                
                <div class="results-grid">
                    <div class="result-row">
                        <div class="result-label">💰 <span data-text="nominal">Nominal</span>:</div>
                        <div class="result-value success" id="nominalResult">0.00</div>
                        <button class="copy-btn success" onclick="copyResult('nominalResult')">📋</button>
                    </div>
                    
                    <div class="result-row">
                        <div class="result-label">⚖️ <span data-text="margin">Margin</span>:</div>
                        <div class="result-value warning" id="marginResult">0.00</div>
                        <button class="copy-btn warning" onclick="copyResult('marginResult')">📋</button>
                    </div>
                    
                    <div class="result-row">
                        <div class="result-label">🛑 <span data-text="sl_price">Stop-Loss</span>:</div>
                        <div class="result-value danger" id="slResult">0.00</div>
                        <button class="copy-btn danger" onclick="copyResult('slResult')">📋</button>
                    </div>
                    
                    <div class="result-row">
                        <div class="result-label">🥉 <span data-text="tp1">TP1</span>:</div>
                        <div class="result-value profit" id="tp1Result">0.00</div>
                        <button class="copy-btn profit" onclick="copyResult('tp1Result')">📋</button>
                    </div>
                    
                    <div class="result-row">
                        <div class="result-label">🥈 <span data-text="tp2">TP2</span>:</div>
                        <div class="result-value profit" id="tp2Result">0.00</div>
                        <button class="copy-btn profit" onclick="copyResult('tp2Result')">📋</button>
                    </div>
                    
                    <div class="result-row">
                        <div class="result-label">🥇 <span data-text="tp3">TP3</span>:</div>
                        <div class="result-value profit" id="tp3Result">0.00</div>
                        <button class="copy-btn profit" onclick="copyResult('tp3Result')">📋</button>
                    </div>
                </div>
            </div>

            <!-- PnL Analysis -->
            <div class="card">
                <div class="section-title">💹 Profit & Loss Analyse</div>
                <div class="pnl-info" id="pnlInfo"></div>
            </div>
        </div>
    </div>

    <script>
        // Translation system
        const translations = {
            german: {
                title: "💹 Nominalwert-Rechner",
                basic_settings: "📊 Basis-Einstellungen",
                direction: "Richtung:",
                long: "📈 Long",
                short: "📉 Short",
                entry_price: "Einstiegskurs:",
                max_loss: "Max. Verlust (€):",
                stop_loss: "Stop-Loss (%):",
                results: "📈 Berechnungsergebnisse",
                nominal: "Nominal",
                margin: "Margin",
                sl_price: "Stop-Loss",
                tp1: "TP1",
                tp2: "TP2", 
                tp3: "TP3",
                calculate: "🚀 Berechnen",
                number_format: "Zahlenformat:",
                language: "Sprache:"
            },
            english: {
                title: "💹 Nominal Value Calculator",
                basic_settings: "📊 Basic Settings",
                direction: "Direction:",
                long: "📈 Long",
                short: "📉 Short",
                entry_price: "Order Price:",
                max_loss: "Max. Loss (€):",
                stop_loss: "Stop-Loss (%):",
                results: "📈 Calculation Results",
                nominal: "Nominal Value",
                margin: "Margin",
                sl_price: "Stop-Loss",
                tp1: "TP1",
                tp2: "TP2",
                tp3: "TP3", 
                calculate: "🚀 Calculate",
                number_format: "Number Format:",
                language: "Language:"
            }
        };

        let currentLanguage = 'german';
        let currentNumberFormat = 'german';
        let settings = {
            makerFee: 0.014,
            takerFee: 0.042,
            numberFormat: 'german',
            language: 'german'
        };

        // Load settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('nominalwert-settings');
            if (saved) {
                settings = {...settings, ...JSON.parse(saved)};
                currentLanguage = settings.language;
                currentNumberFormat = settings.numberFormat;
                
                // Apply settings to UI
                document.getElementById('makerFee').value = settings.makerFee;
                document.getElementById('takerFee').value = settings.takerFee;
                document.getElementById('numberFormat').value = settings.numberFormat;
                document.getElementById('language').value = settings.language;
                
                updateLanguageUI();
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            settings.makerFee = parseFloat(document.getElementById('makerFee').value) || 0.014;
            settings.takerFee = parseFloat(document.getElementById('takerFee').value) || 0.042;
            settings.numberFormat = document.getElementById('numberFormat').value;
            settings.language = document.getElementById('language').value;
            
            localStorage.setItem('nominalwert-settings', JSON.stringify(settings));
            
            currentLanguage = settings.language;
            currentNumberFormat = settings.numberFormat;
            
            alert(currentLanguage === 'german' ? 'Einstellungen gespeichert.' : 'Settings saved.');
            updateLanguageUI();
        }

        // Update language UI
        function updateLanguageUI() {
            document.body.className = `lang-${currentLanguage.substring(0,2)}`;
            
            // Update all text elements
            document.querySelectorAll('[data-text]').forEach(el => {
                const key = el.getAttribute('data-text');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    el.textContent = translations[currentLanguage][key];
                }
            });
        }

        // Number formatting functions
        function parseNumber(str) {
            if (!str) return 0;
            str = str.toString().trim();
            
            console.log('Parsing:', str); // Debug log
            
            // Smart number format detection regardless of current setting
            if (str.includes(',') && str.includes('.')) {
                // Check position to determine format
                const commaPos = str.lastIndexOf(',');
                const dotPos = str.lastIndexOf('.');
                console.log('Comma pos:', commaPos, 'Dot pos:', dotPos); // Debug log
                
                if (commaPos > dotPos) {
                    // German format: 4.435,01 -> dots=thousands, comma=decimal
                    str = str.replace(/\./g, '').replace(',', '.');
                    console.log('German format result:', str); // Debug log
                } else {
                    // US format: 115,130.1 -> commas=thousands, dot=decimal
                    str = str.replace(/,/g, '');
                    console.log('US format result:', str); // Debug log
                }
            } else if (str.includes(',')) {
                // Only comma present
                if (currentNumberFormat === 'german') {
                    // German: treat comma as decimal separator
                    str = str.replace(',', '.');
                    console.log('German comma only result:', str); // Debug log
                } else {
                    // US: treat comma as thousands separator
                    str = str.replace(/,/g, '');
                    console.log('US comma only result:', str); // Debug log
                }
            }
            // If only dots or no separators, leave as-is
            
            const result = parseFloat(str) || 0;
            console.log('Final parsed result:', result); // Debug log
            return result;
        }

        function formatNumber(value, decimals = 2) {
            if (currentNumberFormat === 'german') {
                return value.toLocaleString('de-DE', {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                });
            } else {
                return value.toLocaleString('en-US', {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                });
            }
        }

        // UI Functions
        function updateDirection() {
            const longBtn = document.querySelector('.radio-btn.long');
            const shortBtn = document.querySelector('.radio-btn.short');
            const selected = document.querySelector('input[name="direction"]:checked').value;
            
            if (selected === 'long') {
                longBtn.classList.add('selected');
                shortBtn.classList.remove('selected');
            } else {
                shortBtn.classList.add('selected');
                longBtn.classList.remove('selected');
            }
        }

        function updateLeverage() {
            const value = document.getElementById('leverageSlider').value;
            document.getElementById('leverageDisplay').textContent = value + 'X';
        }

        function setLeverage(value) {
            document.getElementById('leverageSlider').value = value;
            updateLeverage();
        }

        function toggleCollapsible(button) {
            const content = button.nextElementSibling;
            const isOpen = content.classList.contains('active');
            
            if (isOpen) {
                content.classList.remove('active');
                button.textContent = button.textContent.replace('▼', '▶');
            } else {
                content.classList.add('active');
                button.textContent = button.textContent.replace('▶', '▼');
            }
        }

        function updateTPMode() {
            const mode = document.getElementById('tpMode').value;
            const rMultiple = document.getElementById('tpRMultiple');
            const percent = document.getElementById('tpPercent');
            
            if (mode === 'r-multiple') {
                rMultiple.style.display = 'grid';
                percent.style.display = 'none';
            } else {
                rMultiple.style.display = 'none';
                percent.style.display = 'grid';
            }
        }

        function updateNumberFormat() {
            currentNumberFormat = document.getElementById('numberFormat').value;
        }

        function updateLanguage() {
            currentLanguage = document.getElementById('language').value;
            updateLanguageUI();
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                calculate();
            }
        }

        function resetInputs() {
            document.getElementById('entryPrice').value = '';
            document.getElementById('maxLoss').value = '10.00';
            document.getElementById('stopLoss').value = '0.51';
            document.querySelector('input[name="direction"][value="long"]').checked = true;
            updateDirection();
            setLeverage(1);
            
            // Clear results
            ['nominalResult', 'marginResult', 'slResult', 'tp1Result', 'tp2Result', 'tp3Result'].forEach(id => {
                document.getElementById(id).textContent = '0.00';
            });
            document.getElementById('pnlInfo').textContent = '';
        }

        // Main calculation function
        function calculate() {
            try {
                const direction = document.querySelector('input[name="direction"]:checked').value;
                const entryPrice = parseNumber(document.getElementById('entryPrice').value);
                const maxLoss = parseNumber(document.getElementById('maxLoss').value);
                const stopLossPercent = parseNumber(document.getElementById('stopLoss').value);
                const leverage = parseInt(document.getElementById('leverageSlider').value);
                
                if (entryPrice <= 0) throw new Error('Entry price must be > 0');
                if (stopLossPercent <= 0) throw new Error('Stop-Loss % must be > 0');
                if (maxLoss <= 0) throw new Error('Max Loss must be > 0');
                
                // Get fees
                const entrySide = document.getElementById('entrySide').value;
                const exitSide = document.getElementById('exitSide').value;
                const entryFee = entrySide === 'Maker' ? settings.makerFee : settings.takerFee;
                const exitFee = exitSide === 'Maker' ? settings.makerFee : settings.takerFee;
                const totalFeePct = entryFee + exitFee;
                
                // Calculate nominal value
                const effectivePct = (stopLossPercent + totalFeePct) / 100;
                const nominal = maxLoss / (stopLossPercent / 100);
                const marginRequired = nominal / leverage;
                const units = nominal / entryPrice;
                
                // Calculate Stop-Loss price
                const slPrice = direction === 'long' 
                    ? entryPrice * (1 - stopLossPercent/100)
                    : entryPrice * (1 + stopLossPercent/100);
                
                const slDistance = Math.abs(entryPrice - slPrice);
                
                // Calculate Take-Profit prices
                const tpMode = document.getElementById('tpMode').value;
                let tp1, tp2, tp3;
                
                if (tpMode === 'r-multiple') {
                    const tp1r = parseNumber(document.getElementById('tp1r').value);
                    const tp2r = parseNumber(document.getElementById('tp2r').value);
                    const tp3r = parseNumber(document.getElementById('tp3r').value);
                    
                    if (direction === 'long') {
                        tp1 = entryPrice + tp1r * slDistance;
                        tp2 = entryPrice + tp2r * slDistance;
                        tp3 = entryPrice + tp3r * slDistance;
                    } else {
                        tp1 = entryPrice - tp1r * slDistance;
                        tp2 = entryPrice - tp2r * slDistance;
                        tp3 = entryPrice - tp3r * slDistance;
                    }
                } else {
                    const tp1p = parseNumber(document.getElementById('tp1p').value);
                    const tp2p = parseNumber(document.getElementById('tp2p').value);
                    const tp3p = parseNumber(document.getElementById('tp3p').value);
                    
                    const sign = direction === 'long' ? 1 : -1;
                    tp1 = entryPrice * (1 + sign * tp1p/100);
                    tp2 = entryPrice * (1 + sign * tp2p/100);
                    tp3 = entryPrice * (1 + sign * tp3p/100);
                }
                
                // Calculate P&L
                function calculatePnL(price) {
                    const gross = direction === 'long' 
                        ? (price - entryPrice) * units
                        : (entryPrice - price) * units;
                    const fees = nominal * (totalFeePct / 100);
                    return { gross, net: gross - fees };
                }
                
                const slPnL = calculatePnL(slPrice);
                const tp1PnL = calculatePnL(tp1);
                const tp2PnL = calculatePnL(tp2);
                const tp3PnL = calculatePnL(tp3);
                
                // Update results
                document.getElementById('nominalResult').textContent = formatNumber(nominal);
                document.getElementById('marginResult').textContent = formatNumber(marginRequired);
                document.getElementById('slResult').textContent = formatNumber(slPrice, 6);
                document.getElementById('tp1Result').textContent = formatNumber(tp1, 6);
                document.getElementById('tp2Result').textContent = formatNumber(tp2, 6);
                document.getElementById('tp3Result').textContent = formatNumber(tp3, 6);
                
                // Update P&L info
                const pnlText = [
                    `Gebühren: Entry ${formatNumber(entryFee, 3)}% + Exit ${formatNumber(exitFee, 3)}% = ${formatNumber(totalFeePct, 3)}%`,
                    `Effektives Risiko: ${formatNumber(stopLossPercent + totalFeePct, 3)}% • Hebel: ${leverage}×`,
                    '',
                    `SL → Brutto: ${formatNumber(slPnL.gross)} | Netto: ${formatNumber(slPnL.net)}`,
                    `TP1 → Brutto: ${formatNumber(tp1PnL.gross)} | Netto: ${formatNumber(tp1PnL.net)}`,
                    `TP2 → Brutto: ${formatNumber(tp2PnL.gross)} | Netto: ${formatNumber(tp2PnL.net)}`,
                    `TP3 → Brutto: ${formatNumber(tp3PnL.gross)} | Netto: ${formatNumber(tp3PnL.net)}`
                ].join('\n');
                
                document.getElementById('pnlInfo').textContent = pnlText;
                
            } catch (error) {
                alert(`Fehler: ${error.message}`);
            }
        }

        // Copy to clipboard with feedback
        function copyResult(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const button = element.nextElementSibling;
                const originalText = button.textContent;
                button.textContent = '🟢✅';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 1000);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updateDirection();
            updateLeverage();
            updateTPMode();
        });
    </script>
</body>
</html>
